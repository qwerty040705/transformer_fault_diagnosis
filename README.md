# üöÄ Transformer Fault Diagnosis

This repository contains a full pipeline for simulating motor faults, generating labeled time-series data, and training a Transformer-based fault diagnosis model.  

‚öôÔ∏è **Data Generation**  
Data can be generated by running `data_generate/data_generate.py`. When executed, enter the desired number of links at the `How many links?:` prompt, the desired number of samples at the `How many samples?:` prompt, and the number of workers for parallel processing at the `How many workers? (0 = AUTO, WARNING: uses all CPU cores & more RAM):` prompt.

üíæ **Output Location**  
Once the script finishes, the generated dataset will be saved in `data_storage/link_{number_of_links}/fault_dataset.npz`.  

ü©∫ **Data Integrity Check**  
To verify the integrity of the dataset, `check_dataset_NaN_inf.py` can be used to detect any NaN or Inf values.  

üîç **Detailed Inspection**  
For a closer inspection, `check_dataset_SE3.py` allows you to view the label array (fault status), the desired and actual SE(3) transformation matrices, as well as their decomposed position vectors and rotation matrices for specific samples and timesteps, and it also lists fault occurrences in `(time, motor)` format.  



<p>&nbsp;</p>
<p>&nbsp;</p>
### üíª How to generate Data

**1) Data Generation**
```bash
$ python3 data_generate/data_generate.py
How many links?: 1
How many samples?: 100
How many workers? (0 = AUTO, WARNING: uses all CPU cores & more RAM): 2
Generating samples [####################################################################################################] 100.0% (100/100)
Dataset saved successfully to data_storage/link_1/fault_dataset.npz
```

**2) Data Integrity Check**
```bash
$ python3 check_dataset_NaN_inf.py
How many links do you want to check?: 1
‚úÖ desired: No NaN/inf found.
‚úÖ actual: No NaN/inf found.
‚úÖ label: No NaN/inf found.
```

**3) Detailed Inspection**
```bash
$ python3 check_dataset_SE3.py
How many links do you want to check?: 1
desired.shape = (100, 200, 4, 4)
actual.shape  = (100, 200, 4, 4)
label.shape   = (100, 200, 8) (motor_count=8)

==================================================
[Sample 0, Time 0]
Motor labels: [1 1 1 1 1 1 1 1]

Desired SE(3):
 [[ 0.88056938  0.43114424  0.19675417  0.88056938]
 [-0.18371408 -0.07215812  0.98032767 -0.18371408]
 [ 0.43686004 -0.89939304  0.01566704  0.43686004]
 [ 0.          0.          0.          1.        ]]

Actual SE(3):
 [[ 0.88056938  0.43114424  0.19675417  0.88056938]
 [-0.18371408 -0.07215812  0.98032767 -0.18371408]
 [ 0.43686004 -0.89939304  0.01566704  0.43686004]
 [ 0.          0.          0.          1.        ]]

==================================================
[Sample 0, Time 100]
Motor labels: [1 1 1 1 1 1 1 0]

Desired SE(3):
 [[ 0.88056938  0.43114424  0.19675417  0.87490948]
 [-0.18371408 -0.07215812  0.98032767 -0.18908315]
 [ 0.43686004 -0.89939304  0.01566704  0.44584859]
 [ 0.          0.          0.          1.        ]]

Actual SE(3):
 [[ 0.77758677  0.59474917  0.20403978  0.77758677]
 [-0.09997082 -0.20343514  0.97397124 -0.09997082]
 [ 0.62077745 -0.77774518 -0.09873091  0.62077745]
 [ 0.          0.          0.          1.        ]]

==================================================
[Sample 0, Time 199]
Motor labels: [1 1 1 1 1 1 1 0]

Desired SE(3):
 [[ 0.88056938  0.43114424  0.19675417  0.86854637]
 [-0.18371408 -0.07215812  0.98032767 -0.19693976]
 [ 0.43686004 -0.89939304  0.01566704  0.45479879]
 [ 0.          0.          0.          1.        ]]

Actual SE(3):
 [[ 0.34617462 -0.14209196 -0.9273473   0.34617462]
 [ 0.09157589 -0.97862585  0.18413394  0.09157589]
 [-0.93368998 -0.14866515 -0.32576324 -0.93368998]
 [ 0.          0.          0.          1.        ]]
```



<p>&nbsp;</p>
<p>&nbsp;</p>
### üíª How to train and test a Transformer-based model

**1) Training** üõ†
```bash
$ python3 Transformer/train_fault_transformer.py
How many links?: 1
Loaded: S=100, T=200, M=8 (motors) from link_1
Rough global mean/std (pre-split): [ 0.42035538  0.11601146 -0.12616944  0.4205528 ] [0.25689954 0.5769383  0.62854725 0.25677335]
[001] train_loss=0.7148 | val_loss=0.4645
  -> saved best to /home/cdb/transformer_fault_diagnosis/Transformer/Transformer_link_1.pth
[002] train_loss=0.4147 | val_loss=0.4093
  -> saved best to /home/cdb/transformer_fault_diagnosis/Transformer/Transformer_link_1.pth
[003] train_loss=0.3456 | val_loss=0.4230
  No improvement. Patience counter: 1/10
...
[012] train_loss=0.2750 | val_loss=0.5053
  No improvement. Patience counter: 10/10
Early stopping triggered.
```

**2) Testing** üß™
```bash
$ python3 Transformer/eval_fault_transformer.py
How many links?: 1
==== Validation Metrics ====
AUROC  macro: nan | micro: nan
AUPRC  macro: 0.9047 | micro: 0.8898
F1@0.5 macro: 0.9252 | micro: 0.9298
Per-motor F1: 0.919 0.750 0.974 0.889 0.974 1.000 0.947 0.947
```